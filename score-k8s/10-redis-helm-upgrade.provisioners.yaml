- uri: cmd://bash#helm-upgrade-redis
  type: redis
  args:
  - -c
  - |
    if [ -z "$NAMESPACE" ]; then
      echo "Error: The NAMESPACE environment variable shouldn't be empty. That's where the Redis Helm chart will be installed." >&2
      exit 1
    fi
    STDIN=$(cat)
    SERVICE=$(echo $STDIN | yq eval -p json '.resource_id' | yq '. |= sub("\.", "")' | yq '. |= sub("-", "")')
    set -eu -o pipefail
    helm repo add bitnami https://charts.bitnami.com/bitnami >&2
    helm upgrade -i ${SERVICE} bitnami/redis --set replica.replicaCount=1 -n ${NAMESPACE} --wait >&2
    PASSWORD_REFERENCE=$(echo ${SERVICE} | base64).$(echo redis-password | base64)
    OUTPUTS='{"resource_outputs":{"host":"%s-master", "port":"6379", "username":"", "password":"🔐💬%s💬🔐"},"manifests":[]}'
    printf "$OUTPUTS" "$SERVICE" "$PASSWORD_REFERENCE"